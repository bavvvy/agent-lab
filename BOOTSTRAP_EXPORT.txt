--- control/SYSTEM.md ---

# SYSTEM.md

## Architecture version
- 2.1

## Purpose
Agent Lab is a deterministic multi-agent portfolio research and publication system with a constitutional control-plane, system-mode orchestration layer, and execution agents.

## Layered architecture (canonical)
1. `control/` — constitutional layer (authority, invariants, governance)
2. `systems/` — system mode layer (`capital` vs `research` orchestration/config + portfolio definitions)
3. `agents/` — execution layer (runtime code paths, wrappers, and workflows)
4. `inputs/` — shared data layer
5. `outputs/` — mode-scoped artifact layer

Higher layer prevails on conflict.

## Canonical topology
- `control/` — control-plane documentation, invariants, and configuration context.
- `systems/` — mode-scoped orchestration/config:
  - `systems/capital/`
  - `systems/research/`
- `agents/node/` — intake/packaging agent and schema validation.
- `agents/scientist/` — scientist execution pipeline (engine, enforcement, templates, governance).
- `inputs/` — shared inputs (hierarchy/mapping/portfolio definition source datasets).
- `outputs/` — mode-scoped runtime/publication artifacts.
- `contracts/` — generated machine contracts and human briefs.

## System mode invariants
- Capital system must not depend on research system.
- Research system must not mutate or redefine capital doctrine.
- Outputs are scoped by mode under `outputs/<mode>/...`.
- Agents do not own portfolio doctrine; doctrine is system-scoped under `systems/` and constitutionally constrained by `control/`.

## Control-plane / execution separation
- Constitutional definitions live under `control/`.
- System-mode orchestration inputs live under `systems/`.
- Execution code lives under `agents/`.
- Publication/runtime artifacts live under `outputs/`.

## Mode-scoped publication/output paths (canonical)
For each mode (`capital`, `research`):
- Runs: `outputs/<mode>/runs/`
- Archive: `outputs/<mode>/archive/`
- Runtime: `outputs/<mode>/runtime/`

Legacy shared output paths may exist historically under `outputs/capital/legacy/` and are retained as archived artifacts.

## Publication entrypoint
- `agents/scientist/publish.py` is the publication entrypoint wrapper.
- Engine implementation lives at `agents/scientist/engine/publish.py`.

## Deterministic execution model
- Backtest execution is deterministic from local inputs and system mode configuration.
- Publish workflow invokes backtest generation before publication actions.

## Report naming invariant
Versioned report filename format is:
- `YYYY-MM-DD_HH-MM_<strategy>.html`
- Timestamp is UTC minute precision.

## Index ordering invariant
- Index ordering and displayed publish time are derived from filename timestamps.
- Non-conforming filenames are treated as legacy rows by policy utilities.

## Publish workflow invariants
In scientist publish flow:
1. Resolve strategy + mode and validate allowed publication scope.
2. Execute backtest generation for target strategy.
3. Create timestamped report in `outputs/<mode>/runs/`.
4. Ensure `outputs/<mode>/archive/` exists and archive prior timestamped versions.
5. Regenerate `outputs/<mode>/runs/index.html` from filename timestamps.
6. Stage repository changes with `git add -A`.
7. If staged changes exist, run pytest gate before push.
8. Commit and push to `origin/main`.
9. Enforce HEAD parity (`HEAD == origin/main`).

### Timestamp-Only Report Invariant
Only report files matching the format:

`YYYY-MM-DD_HH-MM_<strategy>.html`

may exist in active mode run roots.

Non-timestamped report files such as:

`<strategy>.html`

are prohibited and must not be created by the publish pipeline.

The index must derive entries exclusively from timestamped filenames.
If non-timestamped files are detected, this constitutes architectural drift and must be corrected.

## Immutable Root Policy
Repository root is immutable except for explicitly allowed files.

- Allowed root file: `BOOTSTRAP_EXPORT.txt`
- Identity artifacts must exist ONLY in `control/`
- Runtime layers may not write to repository root

## Repository Identity Invariant
The following files must NOT exist at repository root:
- `AGENTS`
- `BOOTSTRAP`
- `IDENTITY`
- `SOUL`
- `TOOLS`
- `USER`
- `HEARTBEAT`
- `AGENTS.md`
- `BOOTSTRAP.md`
- `IDENTITY.md`
- `SOUL.md`
- `TOOLS.md`
- `USER.md`
- `HEARTBEAT.md`

Identity files are permitted ONLY in:
- `control/`
- agent-local governance subfolders (e.g., `agents/*/governance/`)

If root-level identity files are detected, this constitutes architectural drift and must be corrected before any publish action.

## Node Capability Specification (Passive Mode)
Purpose:
Node is the external interface layer. It ingests unstructured human instructions (e.g., from Discord) and produces structured contracts for execution by Scientist.

Scope (Allowed):
- Ingest natural language instructions.
- Validate payload structure.
- Generate structured JSON requests.
- Generate human-readable briefs.
- Write ONLY to:
  - `contracts/requests/`
  - `contracts/briefs/`
- Node must output `capital_input` objects conforming to `contracts/schema/capital_input_schema.json`.
- Node must not contain allocation logic.
- Cash / beta / alpha doctrine is execution-derived from system definitions and control constraints.

Explicitly Forbidden:
- Modifying `control/`
- Modifying `agents/scientist/`
- Modifying `outputs/`
- Calling `publish.py`
- Executing backtests directly
- Updating `system_config.yaml`
- Introducing new top-level directories
- Writing to repository root

Execution Boundary:
- Scientist must consume structured contracts only.
- Scientist must not parse raw Discord messages.

Autonomy Level:
Node operates in Passive Mode:
- It writes contracts.
- It does NOT trigger execution automatically.

## Guardrails
### Modifiable
- `control/`
- `systems/`
- `agents/node/`
- `agents/scientist/`
- `contracts/`
- `inputs/`

### Protected / caution
- `.git/`
- `outputs/` (artifact space; modify only via execution workflows unless explicitly requested)

### Execution Write Scope Safeguard
Default write targets are restricted to:
- `control/`
- `systems/`
- `agents/node/`
- `agents/scientist/`

Repository-root writes are prohibited unless explicitly triggered by a defined control command.

### Node Write Guardrail
Node write permissions are restricted to:
- `contracts/requests/`
- `contracts/briefs/`

Any attempt to write elsewhere constitutes architectural violation.

## Layered Beta Architecture Invariant
- Hierarchy layer: structure only
- Instrument Mapping layer: implementation mapping only
- Portfolio Definitions layer: allocation definitions only
- Portfolio Models layer: allocation logic only
- Allocator layer: orchestration only

## Multi-agent responsibility summary
- Node agent (`agents/node/`) validates and packages structured requests into contracts.
- Scientist agent (`agents/scientist/`) executes portfolio analytics and publication workflows.
- Scientist consumes structured inputs and derives coherent cash / beta / alpha allocations deterministically.
- Control-plane (`control/`) defines architecture and invariants without replacing runtime truth.

## Control Commands
### generate bootstrap
When the phrase `generate bootstrap` is received, the system must:
1. Overwrite `./BOOTSTRAP_EXPORT.txt` at repository root.
2. Insert full unmodified contents of:
   - `control/SYSTEM.md`
   - `control/CONTEXT_BOOTSTRAP.md`
   - `control/system_config.yaml`
3. Preserve formatting exactly.
4. Confirm only `BOOTSTRAP_EXPORT.txt` changed.
5. Commit with message:
   - `Regenerate portable control-plane bootstrap export`
6. Push to `origin main`.
7. Confirm HEAD parity `TRUE`.

### update system
When the phrase `update system` is received, the system must:
1. Inspect live repository state at repo root.
2. Inspect:
   - `agents/scientist/engine/backtest.py`
   - `agents/scientist/engine/compare.py`
   - `agents/scientist/engine/publish.py`
   - `agents/node/`
   - `systems/`
   - `outputs/`
   - `contracts/`
   - `inputs/`
3. Derive architecture strictly from current repository state.
4. Update ONLY the following files if misaligned:
   - `control/SYSTEM.md`
   - `control/CONTEXT_BOOTSTRAP.md`
   - `control/system_config.yaml`
5. Requirements:
   - Preserve mode-scoped output roots under `outputs/<mode>/`.
   - Preserve timestamp format invariant.
   - Preserve pytest gate + git add + commit + push flow.
   - Preserve HEAD parity enforcement.
   - Preserve Repository Identity Invariant.
   - Do NOT introduce legacy references (e.g., root `reports/`).
6. Do NOT modify:
   - `agents/`
   - `systems/`
   - `outputs/`
   - `contracts/`
   - `.git/`
7. After changes:
   - Show diff summary for modified control files only.
   - Commit with message:
     - `Update control-plane documentation to reflect live repository state`
   - Push to `origin main`.
   - Confirm HEAD parity `TRUE`.

--- control/CONTEXT_BOOTSTRAP.md ---

# CONTEXT_BOOTSTRAP.md

## Architecture version
- 2.0

## High-level architecture
Agent Lab uses a v2 multi-agent structure with explicit separation between control-plane definitions and execution runtime.

- Control-plane: `control/`
- Execution agents: `agents/node/`, `agents/scientist/`
- Artifacts/output plane: `outputs/`
- Contracts plane: `contracts/`

## Responsibility boundaries
### control/
- Owns architecture definitions, invariants, and configuration context.
- Must describe reality of repository state; it does not execute workloads.

### agents/node/
- Owns structured payload validation and request packaging.
- Produces contracts in `contracts/requests/` and briefs in `contracts/briefs/`.

### agents/scientist/
- Owns deterministic backtest execution (`backtest.py`).
- Owns comparative report generation (`compare.py`).
- Owns publication orchestration (`publish.py`).

### outputs/
- Owns publication artifacts and runtime artifacts.
- Canonical publish root is `outputs/reports/`.

## Publication model
- Entrypoint: `agents/scientist/publish.py`
- Publish root: `outputs/reports/`
- Archive path: `outputs/reports/archive/`
- Index path: `outputs/reports/index.html`
- Timestamped artifact format: `YYYY-MM-DD_HH-MM_<strategy>.html` (UTC)
- Index ordering source: filename timestamp parsing

## Invariants
1. Publication writes timestamped reports under `outputs/reports/`.
2. Archive target is `outputs/reports/archive/` and must be created if missing.
3. Index regeneration targets `outputs/reports/index.html`.
4. Index ordering is derived from filename timestamps, not commit time.
5. Publish flow stages changes with `git add -A`.
6. Publish flow executes pytest gate before push when staged changes exist.
7. Publish flow commits and pushes to `origin/main` when changes exist.
8. HEAD parity is enforced at end of publish flow.

## Guardrails
### Modifiable paths
- `control/`
- `agents/node/`
- `agents/scientist/`
- `contracts/`

### Protected paths
- `.git/`
- `outputs/` (artifact plane; do not mutate manually unless explicitly requested)

## Existence assertions (repository state)
- `scientist-workspace/` does not exist in this repository.
- `reports/` at repository root does not exist in this repository.

## Deterministic operating posture
- Derive architecture from current repository state and live execution code.
- Do not assume legacy v1 topology.
- Keep control-plane statements aligned with runtime entrypoints and artifact paths.

--- control/system_config.yaml ---

architecture_version: "2.0"
publication:
  reports_dir: "outputs/reports/"
  archive_dir: "outputs/reports/archive/"
  filename_format: "YYYY-MM-DD_HH-MM_<strategy>.html"
  index_source: "filename_timestamp"
  overwrite_allowed: false
  public_url_root: "https://bavvvy.github.io/agent-lab/outputs/reports/"
workflow:
  publish_script: "agents/scientist/publish.py"
  index_regenerated_within_publish: true
guardrails:
  modifiable_paths:
    - "control/"
    - "agents/node/"
    - "agents/scientist/"
    - "contracts/"
  protected_paths:
    - ".git/"
    - "outputs/"
